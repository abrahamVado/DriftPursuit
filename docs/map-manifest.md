# Terra map catalog

Terra's sandbox viewer boots with a catalog of procedural biomes and optional tile map layouts. The catalog lives in [`viewer/terra/maps.json`](../viewer/terra/maps.json) and is loaded on startup to populate the in-game **Map** dropdown.

## Catalog structure

`maps.json` exposes a top-level object with a `default` map id and a `maps` array. Each entry describes either a procedural Terra stream or a tile map descriptor.

```jsonc
{
  "default": "aurora-basin",
  "maps": [
    {
      "id": "aurora-basin",
      "name": "Aurora Basin",
      "description": "Bright skies over rolling highlands with balanced cover.",
      "type": "procedural",
      "seed": 982451653,
      "chunkSize": 640,
      "radius": 3,
      "environment": {
        "background": "#90b6ff",
        "bodyBackground": "linear-gradient(180deg, #79a7ff 0%, #cfe5ff 45%, #f6fbff 100%)",
        "fog": { "color": "#a4c6ff", "near": 1500, "far": 4200 },
        "sun": { "position": [-420, 580, 780], "intensity": 1.05, "color": "#ffffff" },
        "hemisphere": { "skyColor": "#dce9ff", "groundColor": "#2b4a2e", "intensity": 0.85 }
      },
      "procedural": {
        "noise": { "mountains": { "amplitude": 160 } },
        "colors": { "mid": "#c37b3b" }
      }
    },
    {
      "id": "creator-showcase",
      "name": "Creator Showcase",
      "description": "Authored tile set with custom props.",
      "type": "tilemap",
      "path": "creator-showcase/map.json",
      "tileSize": 900,
      "visibleRadius": 2
    }
  ]
}
```

Common fields:

* `id` – stable identifier used for URL deep links and the Terra HUD dropdown.
* `name` – label shown inside the UI.
* `description` – optional tooltip copy shown on hover.
* `type` – `procedural` (default) or `tilemap`.
* `environment` – overrides for the viewer backdrop, fog, sun, and hemisphere lighting.
* `seed`, `chunkSize`, `radius` – procedural world-streamer settings.
* `procedural` / `generator` – advanced overrides for Terra's terrain generator. See [Procedural overrides](#procedural-overrides).
* `path` – relative path from `maps.json` to a tile map descriptor. Use when `type` is `tilemap`.
* `descriptor` – inline tile map descriptor (alternative to `path`).
* `tileSize`, `visibleRadius` – tile map grid size (in metres) and how many tiles load around the camera.
* `assetRoot` – base URL prepended to relative asset references inside a descriptor.

If `default` is omitted the first valid entry becomes the fallback. Missing or invalid downloads are replaced by the baked-in catalog inside `viewer/terra/main.js`.

## Tile map descriptors

Tile map descriptors can be loaded inline via `descriptor` or fetched from the `path` provided in a map entry. Descriptors describe authored chunks on a grid. Each chunk can define ground elevation via a heightfield and spawn props.

```jsonc
{
  "id": "creator-showcase",
  "type": "tilemap",
  "tileSize": 900,
  "visibleRadius": 2,
  "fallback": { "baseHeight": 0 },
  "tiles": [
    {
      "coords": [0, 0],
      "baseHeight": 0,
      "groundColor": "#546e4f",
      "heightfield": {
        "rows": 33,
        "cols": 33,
        "scale": { "z": 18 },
        "data": [0.1, 0.119, "…"],
        "material": { "color": "#546e4f" }
      },
      "objects": [
        {
          "type": "box",
          "size": [140, 80, 32],
          "position": [-210, 140, 0],
          "rotationDegrees": [0, 0, 8],
          "material": { "color": "#9aa7b7" }
        },
        { "type": "tree", "position": [220, 220, 0], "scale": 1.1 }
      ]
    }
  ]
}
```

Key fields:

* `coords` – integer `[x, y]` tile coordinate.
* `baseHeight` / `elevation` – ground plane height at the tile origin.
* `heightfield` – optional dense height sample grid. `rows × cols` samples are expected; `scale.z` sets metres-per-sample vertically.
* `groundColor` – fallback colour for autogenerated planes when no heightfield is present.
* `objects` – list of props. Supported `type` values include `box`, `cylinder`, `plane`, and `tree`. Props honour `position`, `rotation` / `rotationDegrees`, `scale`, and optional `material` settings.
* `fallback` – controls the background plane used for tiles that are not explicitly authored.

Any tile not described in the descriptor falls back to a flat plane at `fallback.baseHeight`. The Terra streamer keeps loading the authored radius around the current focus point while the procedural world fills the horizon.

## Map selection flow

When Terra boots it downloads `viewer/terra/maps.json`, merges any descriptor data, and activates the requested map.

* The viewer inspects the `?map=<id>` query parameter first. If the id exists it is selected immediately.
* If no query parameter is present the catalog's `default` id is used.
* Picking a different map from the in-game dropdown updates the URL and reloads the page so the new descriptor can be applied from scratch.
* Terra caches the last successful selection in-memory for the current session only.

Shareable URLs therefore look like `https://…/terra.html?map=ember-canyon`. Reloading the page is expected after updating the query parameter.

## Procedural overrides

Procedural entries can override Terra's generator without modifying source code. Populate the `procedural` block with the sections you want to tweak—noise layers, biome colours, feature toggles, and so on. See [`viewer/terra/maps.json`](../viewer/terra/maps.json) for shipping presets and refer to [`viewer/terra/main.js`](../viewer/terra/main.js) for the full list of supported knobs. Tile maps can also provide a `procedural` block inside their descriptor to control fallback chunks.

## Legacy manifest

Older builds of the viewer referenced `viewer/assets/maps/manifest.json`. That file now carries a legacy note and should not be used as a template for Terra maps. Always author new content through `viewer/terra/maps.json`.
